<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comparador Profesional de Remitos</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{
    font-family: Arial;
    background:#f4f6f9;
    padding:20px;
}
.container{
    max-width:1000px;
    margin:auto;
    background:white;
    padding:25px;
    border-radius:10px;
    box-shadow:0 0 15px rgba(0,0,0,0.1);
}
h1{text-align:center;}
input, button{
    margin-top:10px;
    width:100%;
    padding:8px;
}
button{
    background:#007bff;
    color:white;
    border:none;
    border-radius:5px;
    cursor:pointer;
}
button:hover{background:#0056b3;}
.result{
    margin-top:20px;
    padding:15px;
    background:#eef2f7;
    border-radius:8px;
    white-space: pre-wrap;
}
.ok{
    color:green;
    font-weight:bold;
    font-size:18px;
}
.diff{
    color:red;
    font-weight:bold;
}
</style>
</head>

<body>
<div class="container">
<h1>ðŸ“„ Comparador 1101 / 1104 (Ãšltimos 5 DÃ­gitos)</h1>

<label>Subir Archivo 1:</label>
<input type="file" id="file1">

<label>Subir Archivo 2:</label>
<input type="file" id="file2">

<button onclick="comparar()">Comparar Archivos</button>
<button onclick="reiniciar()">Reiniciar</button>

<div class="result" id="resultado"></div>
</div>

<script>
let contenidoArchivo1 = "";
let contenidoArchivo2 = "";

/* ===============================
   LECTURA DE ARCHIVOS
================================ */

async function leerArchivo(file){
    const extension = file.name.split('.').pop().toLowerCase();

    if(extension === "pdf") return await leerPDF(file);
    if(extension === "xlsx" || extension === "xls") return await leerExcel(file);
    if(extension === "csv" || extension === "txt") return await leerTexto(file);

    alert("Formato no soportado");
    return "";
}

async function leerTexto(file){
    return new Promise(resolve=>{
        const reader = new FileReader();
        reader.onload = e=>resolve(e.target.result);
        reader.readAsText(file);
    });
}

async function leerExcel(file){
    return new Promise(resolve=>{
        const reader = new FileReader();
        reader.onload = function(e){
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data,{type:'array'});
            let texto = "";
            workbook.SheetNames.forEach(name=>{
                texto += XLSX.utils.sheet_to_csv(workbook.Sheets[name]);
            });
            resolve(texto);
        }
        reader.readAsArrayBuffer(file);
    });
}

async function leerPDF(file){
    const pdfData = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
    let texto = "";

    for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item=>item.str);
        texto += strings.join("\n") + "\n";
    }
    return texto;
}

/* ===============================
   EXTRACCION Y NORMALIZACION
================================ */

function extraerRemitos(texto){
    // Detecta 1101-, 1104- o 3008- seguido de 5 a 8 dÃ­gitos
    const regex = /\b(1101|1104|3008)-(\d{5,8})\b/g;
    let match;
    let set = new Set();

    while((match = regex.exec(texto)) !== null){
        let punto = match[1];
        let numero = match[2];
        let ultimos5;

        if(numero.length === 8){
            ultimos5 = numero.slice(3);
        }else{
            ultimos5 = numero;
        }

        let clave = punto + "-" + ultimos5;
        set.add(clave);
    }

    return set;
}

/* ===============================
   EXTRAER LINEAS POR REMITO
================================ */

function lineasPorRemito(texto, remito){
    let lineas = texto.split(/\r?\n/);
    let coincidencias = lineas.filter(linea=>{
        const regex = new RegExp(remito.replace("-","-"), "i");
        return regex.test(linea);
    });
    return coincidencias.length>0 ? coincidencias.join("\n") : "No se encontrÃ³ la lÃ­nea";
}

/* ===============================
   COMPARACION
================================ */

function compararSets(set1, set2){
    let faltanEn2 = [];
    let faltanEn1 = [];

    set1.forEach(valor=>{
        if(!set2.has(valor)) faltanEn2.push(valor);
    });

    set2.forEach(valor=>{
        if(!set1.has(valor)) faltanEn1.push(valor);
    });

    return {faltanEn1, faltanEn2};
}

/* ===============================
   FUNCION PRINCIPAL
================================ */

async function comparar(){
    const file1 = document.getElementById("file1").files[0];
    const file2 = document.getElementById("file2").files[0];
    const resultadoDiv = document.getElementById("resultado");

    if(!file1 || !file2){
        alert("Debes subir ambos archivos");
        return;
    }

    resultadoDiv.innerHTML = "Analizando...";

    contenidoArchivo1 = await leerArchivo(file1);
    contenidoArchivo2 = await leerArchivo(file2);

    const set1 = extraerRemitos(contenidoArchivo1);
    const set2 = extraerRemitos(contenidoArchivo2);

    const resultado = compararSets(set1, set2);

    let html = "";

    if(resultado.faltanEn1.length === 0 && resultado.faltanEn2.length === 0){
        html = `<p class="ok">âœ… ComparaciÃ³n completa: EstÃ¡n todos los remitos.</p>`;
        html += `<p>Total Archivo 1: ${set1.size}</p>`;
        html += `<p>Total Archivo 2: ${set2.size}</p>`;
    }else{
        html = `<p class="diff">âš  Se detectaron diferencias</p>`;

        if(resultado.faltanEn2.length > 0){
            html += `<p class="diff"><br>Faltan en Archivo 2:</p>`;
            resultado.faltanEn2.forEach(r=>{
                html += `<p class="diff">${r}</p>`;
                html += `<pre>${lineasPorRemito(contenidoArchivo1,r)}</pre>`;
            });
        }

        if(resultado.faltanEn1.length > 0){
            html += `<p class="diff"><br>Faltan en Archivo 1:</p>`;
            resultado.faltanEn1.forEach(r=>{
                html += `<p class="diff">${r}</p>`;
                html += `<pre>${lineasPorRemito(contenidoArchivo2,r)}</pre>`;
            });
        }
    }

    resultadoDiv.innerHTML = html;
}

/* ===============================
   REINICIAR
================================ */

function reiniciar(){
    document.getElementById("file1").value = "";
    document.getElementById("file2").value = "";
    document.getElementById("resultado").innerHTML = "";
    contenidoArchivo1 = "";
    contenidoArchivo2 = "";
}
</script>
</body>
</html>
