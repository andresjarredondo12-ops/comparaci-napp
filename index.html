<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comparador Inteligente de Documentos - Remitos</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{
    font-family: Arial;
    background:#f4f6f9;
    padding:20px;
}
.container{
    max-width:1000px;
    margin:auto;
    background:white;
    padding:25px;
    border-radius:10px;
    box-shadow:0 0 15px rgba(0,0,0,0.1);
}
h1{text-align:center;}
input, textarea, button{
    margin-top:10px;
    width:100%;
    padding:8px;
}
button{
    background:#007bff;
    color:white;
    border:none;
    border-radius:5px;
    cursor:pointer;
}
button:hover{background:#0056b3;}
.result{
    margin-top:20px;
    padding:15px;
    background:#eef2f7;
    border-radius:8px;
}
.ok{color:green;font-weight:bold;}
.diff{color:red;font-weight:bold;}
.section{
    margin-top:20px;
    padding:10px;
    background:#ffffff;
    border-left:5px solid #007bff;
}
</style>
</head>

<body>
<div class="container">
<h1>ðŸ“„ Comparador Avanzado de Documentos</h1>

<label>Subir Archivo 1:</label>
<input type="file" id="file1">

<label>Subir Archivo 2:</label>
<input type="file" id="file2">

<label>Otros parÃ¡metros a comparar (separados por coma):</label>
<textarea id="params" placeholder="Ej: cliente, importe, fecha"></textarea>

<button onclick="comparar()">Comparar Archivos</button>

<div class="result" id="resultado"></div>
</div>

<script>

async function leerArchivo(file){
    const extension = file.name.split('.').pop().toLowerCase();

    if(extension === "pdf") return await leerPDF(file);
    if(extension === "xlsx" || extension === "xls") return await leerExcel(file);
    if(extension === "csv" || extension === "txt") return await leerTexto(file);

    alert("Formato no soportado: " + extension);
    return "";
}

async function leerTexto(file){
    return new Promise(resolve=>{
        const reader = new FileReader();
        reader.onload = e=>resolve(e.target.result);
        reader.readAsText(file);
    });
}

async function leerExcel(file){
    return new Promise(resolve=>{
        const reader = new FileReader();
        reader.onload = function(e){
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data,{type:'array'});
            let texto = "";
            workbook.SheetNames.forEach(name=>{
                texto += XLSX.utils.sheet_to_csv(workbook.Sheets[name]);
            });
            resolve(texto);
        }
        reader.readAsArrayBuffer(file);
    });
}

async function leerPDF(file){
    const pdfData = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
    let texto = "";

    for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item=>item.str);
        texto += strings.join(" ") + " ";
    }
    return texto;
}

/* ===============================
   FUNCION ESPECIAL PARA REMITOS
   =============================== */

function extraerRemitos(texto){
    const regex = /\b(1101|1104)-?0*(\d{1,8})\b/g;
    let match;
    let remitos = [];

    while((match = regex.exec(texto)) !== null){
        let prefijo = match[1];
        let numeroCompleto = match[2];

        // Tomamos los Ãºltimos 5 dÃ­gitos
        let ultimos5 = numeroCompleto.slice(-5);

        remitos.push(prefijo + "-" + ultimos5);
    }

    return [...new Set(remitos)];
}

function compararRemitos(remitos1, remitos2){
    let coinciden = [];
    let soloEn1 = [];
    let soloEn2 = [];

    remitos1.forEach(r=>{
        if(remitos2.includes(r)){
            coinciden.push(r);
        }else{
            soloEn1.push(r);
        }
    });

    remitos2.forEach(r=>{
        if(!remitos1.includes(r)){
            soloEn2.push(r);
        }
    });

    return {coinciden, soloEn1, soloEn2};
}

/* ===============================
   PARAMETROS GENERALES
   =============================== */

function buscarParametro(texto,param){
    const regex = new RegExp(param + "\\s*[:\\-]?\\s*([\\w\\d\\.\\/\\-]+)", "i");
    const match = texto.match(regex);
    return match ? match[1] : "NO ENCONTRADO";
}

/* ===============================
   FUNCION PRINCIPAL
   =============================== */

async function comparar(){

    const file1 = document.getElementById("file1").files[0];
    const file2 = document.getElementById("file2").files[0];
    const params = document.getElementById("params").value.split(",").map(p=>p.trim());
    const resultadoDiv = document.getElementById("resultado");

    if(!file1 || !file2){
        alert("Debes subir ambos archivos");
        return;
    }

    resultadoDiv.innerHTML = "Analizando archivos...";

    const texto1 = await leerArchivo(file1);
    const texto2 = await leerArchivo(file2);

    let resultadoHTML = "<h3>Resultado de ComparaciÃ³n</h3>";

    /* ===== COMPARACION DE REMITOS ===== */

    const remitos1 = extraerRemitos(texto1);
    const remitos2 = extraerRemitos(texto2);

    const resultadoRemitos = compararRemitos(remitos1, remitos2);

    resultadoHTML += `<div class="section"><h4>ComparaciÃ³n de Remitos (1101 / 1104)</h4>`;

    resultadoHTML += `<p class="ok">âœ” Coinciden (${resultadoRemitos.coinciden.length})</p>`;
    resultadoHTML += resultadoRemitos.coinciden.join("<br>");

    resultadoHTML += `<p class="diff"><br>âœ– Solo en Archivo 1 (${resultadoRemitos.soloEn1.length})</p>`;
    resultadoHTML += resultadoRemitos.soloEn1.join("<br>");

    resultadoHTML += `<p class="diff"><br>âœ– Solo en Archivo 2 (${resultadoRemitos.soloEn2.length})</p>`;
    resultadoHTML += resultadoRemitos.soloEn2.join("<br>");

    resultadoHTML += `</div>`;

    /* ===== OTROS PARAMETROS ===== */

    if(params[0] !== ""){
        resultadoHTML += `<div class="section"><h4>Otros ParÃ¡metros</h4>`;
        params.forEach(param=>{
            const val1 = buscarParametro(texto1,param);
            const val2 = buscarParametro(texto2,param);

            if(val1 === val2){
                resultadoHTML += `<p class="ok">âœ” ${param}: Coinciden (${val1})</p>`;
            }else{
                resultadoHTML += `<p class="diff">âœ– ${param}: Diferencia â†’ Archivo1: ${val1} | Archivo2: ${val2}</p>`;
            }
        });
        resultadoHTML += `</div>`;
    }

    resultadoDiv.innerHTML = resultadoHTML;
}

</script>
</body>
</html>
