<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comparador Exacto de Remitos</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{
    font-family: Arial;
    background:#f4f6f9;
    padding:20px;
}
.container{
    max-width:1000px;
    margin:auto;
    background:white;
    padding:25px;
    border-radius:10px;
    box-shadow:0 0 15px rgba(0,0,0,0.1);
}
h1{text-align:center;}
input, button{
    margin-top:10px;
    width:100%;
    padding:8px;
}
button{
    background:#007bff;
    color:white;
    border:none;
    border-radius:5px;
    cursor:pointer;
}
button:hover{background:#0056b3;}
.result{
    margin-top:20px;
    padding:15px;
    background:#eef2f7;
    border-radius:8px;
}
.ok{
    color:green;
    font-weight:bold;
    font-size:18px;
}
.diff{
    color:red;
    font-weight:bold;
}
</style>
</head>

<body>
<div class="container">
<h1>ðŸ“„ Comparador Exacto 1101 / 1104</h1>

<label>Subir Archivo 1:</label>
<input type="file" id="file1">

<label>Subir Archivo 2:</label>
<input type="file" id="file2">

<button onclick="comparar()">Comparar Archivos</button>

<div class="result" id="resultado"></div>
</div>

<script>

/* ===============================
   LECTURA DE ARCHIVOS
================================ */

async function leerArchivo(file){
    const extension = file.name.split('.').pop().toLowerCase();

    if(extension === "pdf") return await leerPDF(file);
    if(extension === "xlsx" || extension === "xls") return await leerExcel(file);
    if(extension === "csv" || extension === "txt") return await leerTexto(file);

    alert("Formato no soportado");
    return "";
}

async function leerTexto(file){
    return new Promise(resolve=>{
        const reader = new FileReader();
        reader.onload = e=>resolve(e.target.result);
        reader.readAsText(file);
    });
}

async function leerExcel(file){
    return new Promise(resolve=>{
        const reader = new FileReader();
        reader.onload = function(e){
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data,{type:'array'});
            let texto = "";
            workbook.SheetNames.forEach(name=>{
                texto += XLSX.utils.sheet_to_csv(workbook.Sheets[name]);
            });
            resolve(texto);
        }
        reader.readAsArrayBuffer(file);
    });
}

async function leerPDF(file){
    const pdfData = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
    let texto = "";

    for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item=>item.str);
        texto += strings.join(" ") + " ";
    }
    return texto;
}

/* ===============================
   NORMALIZACION EXACTA
================================ */

function extraerRemitos(texto){

    // Detecta 1101-xxxxx o 1101-xxxxxxxx (igual para 1104)
    const regex = /\b(1101|1104)-(\d{5}|\d{8})\b/g;

    let match;
    let set = new Set();

    while((match = regex.exec(texto)) !== null){

        let punto = match[1];
        let numero = match[2];

        // Normalizar a Ãºltimos 5 dÃ­gitos
        let ultimos5 = numero.slice(-5);

        let clave = punto + "-" + ultimos5;

        set.add(clave);
    }

    return set;
}

/* ===============================
   COMPARACION EXACTA
================================ */

function compararSets(set1, set2){

    let faltanEn2 = [];
    let faltanEn1 = [];

    set1.forEach(valor=>{
        if(!set2.has(valor)){
            faltanEn2.push(valor);
        }
    });

    set2.forEach(valor=>{
        if(!set1.has(valor)){
            faltanEn1.push(valor);
        }
    });

    return {faltanEn1, faltanEn2};
}

/* ===============================
   FUNCION PRINCIPAL
================================ */

async function comparar(){

    const file1 = document.getElementById("file1").files[0];
    const file2 = document.getElementById("file2").files[0];
    const resultadoDiv = document.getElementById("resultado");

    if(!file1 || !file2){
        alert("Debes subir ambos archivos");
        return;
    }

    resultadoDiv.innerHTML = "Analizando...";

    const texto1 = await leerArchivo(file1);
    const texto2 = await leerArchivo(file2);

    const set1 = extraerRemitos(texto1);
    const set2 = extraerRemitos(texto2);

    const resultado = compararSets(set1, set2);

    let html = "";

    if(resultado.faltanEn1.length === 0 && resultado.faltanEn2.length === 0){

        html = `<p class="ok">âœ… ComparaciÃ³n completa: EstÃ¡n todos los remitos en ambos archivos.</p>`;
        html += `<p>Total detectados: ${set1.size}</p>`;

    }else{

        html = `<p class="diff">âš  Se detectaron diferencias</p>`;

        if(resultado.faltanEn2.length > 0){
            html += `<p class="diff"><br>Faltan en Archivo 2:</p>`;
            resultado.faltanEn2.forEach(r=>{
                html += `<p class="diff">${r}</p>`;
            });
        }

        if(resultado.faltanEn1.length > 0){
            html += `<p class="diff"><br>Faltan en Archivo 1:</p>`;
            resultado.faltanEn1.forEach(r=>{
                html += `<p class="diff">${r}</p>`;
            });
        }
    }

    resultadoDiv.innerHTML = html;
}

</script>
</body>
</html>

