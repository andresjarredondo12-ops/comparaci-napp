<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comparador de Remitos 1101 / 1104</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{
    font-family: Arial;
    background:#f4f6f9;
    padding:20px;
}
.container{
    max-width:1000px;
    margin:auto;
    background:white;
    padding:25px;
    border-radius:10px;
    box-shadow:0 0 15px rgba(0,0,0,0.1);
}
h1{text-align:center;}
input, button{
    margin-top:10px;
    width:100%;
    padding:8px;
}
button{
    background:#007bff;
    color:white;
    border:none;
    border-radius:5px;
    cursor:pointer;
}
button:hover{background:#0056b3;}
.result{
    margin-top:20px;
    padding:15px;
    background:#eef2f7;
    border-radius:8px;
}
.ok{color:green;font-weight:bold;}
.diff{color:red;font-weight:bold;}
.section{
    margin-top:20px;
    padding:10px;
    background:#ffffff;
    border-left:5px solid #007bff;
}
</style>
</head>

<body>
<div class="container">
<h1>ðŸ“„ Comparador Inteligente de Remitos</h1>

<label>Subir Archivo 1:</label>
<input type="file" id="file1">

<label>Subir Archivo 2:</label>
<input type="file" id="file2">

<button onclick="comparar()">Comparar Archivos</button>

<div class="result" id="resultado"></div>
</div>

<script>

/* ===============================
   LECTURA DE ARCHIVOS
================================ */

async function leerArchivo(file){
    const extension = file.name.split('.').pop().toLowerCase();

    if(extension === "pdf") return await leerPDF(file);
    if(extension === "xlsx" || extension === "xls") return await leerExcel(file);
    if(extension === "csv" || extension === "txt") return await leerTexto(file);

    alert("Formato no soportado: " + extension);
    return "";
}

async function leerTexto(file){
    return new Promise(resolve=>{
        const reader = new FileReader();
        reader.onload = e=>resolve(e.target.result);
        reader.readAsText(file);
    });
}

async function leerExcel(file){
    return new Promise(resolve=>{
        const reader = new FileReader();
        reader.onload = function(e){
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data,{type:'array'});
            let texto = "";
            workbook.SheetNames.forEach(name=>{
                texto += XLSX.utils.sheet_to_csv(workbook.Sheets[name]);
            });
            resolve(texto);
        }
        reader.readAsArrayBuffer(file);
    });
}

async function leerPDF(file){
    const pdfData = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
    let texto = "";

    for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item=>item.str);
        texto += strings.join(" ") + " ";
    }
    return texto;
}

/* ===============================
   LOGICA REMITOS 1101 / 1104
================================ */

function extraerRemitos(texto){

    // Detecta 1101-xxxxx o 1101-xxxxxxxx
    const regex = /\b(1101|1104)-(\d{5}|\d{8})\b/g;

    let match;
    let remitosNormalizados = [];

    while((match = regex.exec(texto)) !== null){

        let prefijo = match[1];
        let numero = match[2];

        // Si tiene 8 dÃ­gitos, tomar Ãºltimos 5
        if(numero.length === 8){
            numero = numero.slice(-5);
        }

        remitosNormalizados.push(prefijo + "-" + numero);
    }

    // Elimina duplicados
    return [...new Set(remitosNormalizados)];
}

function compararRemitos(lista1, lista2){

    let coinciden = [];
    let soloEn1 = [];
    let soloEn2 = [];

    lista1.forEach(remito=>{
        if(lista2.includes(remito)){
            coinciden.push(remito);
        }else{
            soloEn1.push(remito);
        }
    });

    lista2.forEach(remito=>{
        if(!lista1.includes(remito)){
            soloEn2.push(remito);
        }
    });

    return {coinciden, soloEn1, soloEn2};
}

/* ===============================
   FUNCION PRINCIPAL
================================ */

async function comparar(){

    const file1 = document.getElementById("file1").files[0];
    const file2 = document.getElementById("file2").files[0];
    const resultadoDiv = document.getElementById("resultado");

    if(!file1 || !file2){
        alert("Debes subir ambos archivos");
        return;
    }

    resultadoDiv.innerHTML = "Analizando archivos...";

    const texto1 = await leerArchivo(file1);
    const texto2 = await leerArchivo(file2);

    const remitos1 = extraerRemitos(texto1);
    const remitos2 = extraerRemitos(texto2);

    const resultado = compararRemitos(remitos1, remitos2);

    let html = "<h3>Resultado ComparaciÃ³n Remitos</h3>";

    html += `<div class="section">`;

    html += `<p class="ok">âœ” Coinciden (${resultado.coinciden.length})</p>`;
    html += resultado.coinciden.length ? resultado.coinciden.join("<br>") : "Ninguno";

    html += `<p class="diff"><br>âœ– Solo en Archivo 1 (${resultado.soloEn1.length})</p>`;
    html += resultado.soloEn1.length ? resultado.soloEn1.join("<br>") : "Ninguno";

    html += `<p class="diff"><br>âœ– Solo en Archivo 2 (${resultado.soloEn2.length})</p>`;
    html += resultado.soloEn2.length ? resultado.soloEn2.join("<br>") : "Ninguno";

    html += `</div>`;

    resultadoDiv.innerHTML = html;
}

</script>
</body>
</html>
